<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" href="/favicon.png">

  <title>
  Concluding Serverless Journey - tech-lessons.in
  </title>
  <meta name="description" content="Let&#39;s deploy our Serverless application. We will be using AWS CDK to deploy our application that includes infra and the code. What would be interesting is to see if we can make our infra testable." />
  <meta name="author" content="Sarthak Makhija" />
  
     <meta property="og:image" content="/concluding-serverless.png" />
  <meta name="generator" content="Hugo 0.140.1"><link rel="stylesheet" href="/css/styles.css" />

  
  

  <meta property="og:url" content="//localhost:1313/en/blog/concluding_serverless_journey/">
  <meta property="og:site_name" content="tech-lessons.in">
  <meta property="og:title" content="Concluding Serverless Journey">
  <meta property="og:description" content="Let&#39;s deploy our Serverless application. We will be using AWS CDK to deploy our application that includes infra and the code. What would be interesting is to see if we can make our infra testable.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2020-03-18T00:00:00+00:00">
    <meta property="article:modified_time" content="2020-03-18T00:00:00+00:00">
    <meta property="article:tag" content="AWS Lambda">
    <meta property="article:tag" content="Serverless">
    <meta property="article:tag" content="CDK">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Concluding Serverless Journey">
  <meta name="twitter:description" content="Let&#39;s deploy our Serverless application. We will be using AWS CDK to deploy our application that includes infra and the code. What would be interesting is to see if we can make our infra testable.">

  
  <meta itemprop="name" content="Concluding Serverless Journey">
  <meta itemprop="description" content="Let&#39;s deploy our Serverless application. We will be using AWS CDK to deploy our application that includes infra and the code. What would be interesting is to see if we can make our infra testable.">
  <meta itemprop="datePublished" content="2020-03-18T00:00:00+00:00">
  <meta itemprop="dateModified" content="2020-03-18T00:00:00+00:00">
  <meta itemprop="wordCount" content="3139">
  <meta itemprop="keywords" content="AWS Lambda,Serverless,CDK">

  
</head>
<body class="dark:bg-gray-800 dark:text-white relative flex flex-col min-h-screen"><header class="container flex justify-between md:justify-between gap-4 flex-wrap p-6 mx-auto relative">
  <a href="//localhost:1313/en/" class="capitalize font-extrabold text-2xl">
    
    <img src="/logo.png" alt="tech-lessons.in" class="h-8 max-w-full" />
    
  </a>
  <button class="mobile-menu-button md:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <line x1="4" y1="8" x2="20" y2="8" />
      <line x1="4" y1="16" x2="20" y2="16" />
    </svg>
  </button>
  <ul class="mobile-menu absolute z-10 px-6 pb-6 md:p-0 top-full left-0 w-full md:w-auto md:relative hidden md:flex flex-col md:flex-row items-end md:items-center gap-4 lg:gap-6 bg-white dark:bg-gray-800">

    
    <li><a href="/en/">Home</a></li>
    
    <li><a href="/en/blog">Blogs</a></li>
    
    <li><a href="/en/page/about/">About Me</a></li>
    
    <li><a href="/en/page/projects/">My projects</a></li>
    

    

    
    <li class="grid place-items-center">
      <span class="open-search inline-block cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <circle cx="10" cy="10" r="7" />
          <line x1="21" y1="21" x2="15" y2="15" />
        </svg>
      </span>
    </li>
    

    
  </ul>
</header>
<main class="flex-1">
  
  

  
  <div class="relative max-w-5xl mx-auto px-4">
    <img src="/concluding-serverless.png" class="rounded-lg shadow-sm w-full object-contain" />
    
    <figcaption class="font-extralight text-xs"><i>Background by Tamara Schipchinskaya on Unsplash</i></figcaption>
    
    
    <div class="absolute top-4 right-8 rounded shadow bg-white text-gray-900 dark:bg-gray-900 dark:text-white px-2 py-0.5">
      
  
    March 18, 2020
  


    </div>
    
  </div>
  

  <article class="prose lg:prose-lg mx-auto my-8 dark:prose-dark px-4 max-w-5xl">

    <h1 class="text-2xl font-bold mb-2">Concluding Serverless Journey</h1>
    
    <h5 class="text-sm flex items-center flex-wrap">
      <svg xmlns="http://www.w3.org/2000/svg" class="mr-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <rect x="4" y="5" width="16" height="16" rx="2" />
        <line x1="16" y1="3" x2="16" y2="7" />
        <line x1="8" y1="3" x2="8" y2="7" />
        <line x1="4" y1="11" x2="20" y2="11" />
        <rect x="8" y="15" width="2" height="2" />
      </svg>
      Posted on 
  
    March 18, 2020
  


      
        &nbsp;&bull;&nbsp;
      
      <svg xmlns="http://www.w3.org/2000/svg" class="mr-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <circle cx="12" cy="12" r="9" />
        <polyline points="12 7 12 12 15 15" />
      </svg>
      15&nbsp;minutes
      &nbsp;&bull;
      <svg xmlns="http://www.w3.org/2000/svg" class="mx-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <path d="M3 19a9 9 0 0 1 9 0a9 9 0 0 1 9 0" />
        <path d="M3 6a9 9 0 0 1 9 0a9 9 0 0 1 9 0" />
        <line x1="3" y1="6" x2="3" y2="19" />
        <line x1="12" y1="6" x2="12" y2="19" />
        <line x1="21" y1="6" x2="21" y2="19" />
      </svg>
      3139&nbsp;words
      
    </h5>
    

    <details id="TableOfContents" class="px-4 mt-4 bg-gray-100 dark:bg-gray-700 rounded toc">
    <summary class="flex items-center font-bold py-2 px-4 cursor-pointer justify-between select-none text-black dark:text-white">
      <span>Table of contents</span>
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-down" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <polyline points="6 9 12 15 18 9"></polyline>
     </svg>
    </summary>

    <ul class="mt-2 pb-4">
        

        
        <li>
        <a href="#step-1-setting-up-the-project">Step 1: Setting up the project</a>
        

        
        </li><li>
        <a href="#step-2-creating-stack-with-the-lambda-function">Step 2: Creating stack with the lambda function</a>
        

        
        </li><li>
        <a href="#step-3-fixing-the-test">Step 3: Fixing the test</a>
        

        
        </li><li>
        <a href="#step-4-adding-dynamodb-to-the-stack">Step 4: Adding DynamoDB to the stack</a>
        

        
        </li><li>
        <a href="#step-5-refactoring-the-stack">Step 5: Refactoring the stack</a>
        

        
        </li><li>
        <a href="#step-6-adding-lambda-backed-public-rest-api-to-the-stack">Step 6: Adding lambda backed public REST API to the stack</a>
        

        
        </li><li>
        <a href="#step-7-updating-the-stack">Step 7: Updating the stack</a>
        

        
        </li><li>
        <a href="#step-8-deploying-our-stack">Step 8: Deploying our stack</a>
        

        
        </li><li>
        <a href="#conclusion">Conclusion</a>
        </li></ul>
  </details>

    <p>We have come a long way in our <a href="/en/blog/beginning_serverless_journey">Serverless journey</a>
. This journey which started with building a serverless application has finally come to a stage where we can see all
our hard work in action. We will be deploying our application in this article.</p>
<p>We will be using <a href="https://docs.aws.amazon.com/cdk/latest/guide/home.html" target="_blank" rel="noopener">AWS CDK</a>
 to deploy our application. Before we start using CDK, let&rsquo;s quickly look at what is CDK -</p>
<blockquote>
<p>The AWS Cloud Development Kit (AWS CDK) is an open source software development framework to model and provision your cloud application resources using familiar programming languages.
Provisioning cloud applications can be a challenging process that requires you to perform manual actions, write custom scripts, maintain templates, or learn domain-specific languages.
AWS CDK uses the familiarity and expressive power of programming languages for modeling your applications. It provides you with high-level components that preconfigure cloud resources with
proven defaults, so you can build cloud applications without needing to be an expert. AWS CDK provisions your resources in a safe, repeatable manner through AWS CloudFormation</strong>.
It also enables you to compose and share your own custom components that incorporate your organization&rsquo;s requirements, helping you start new projects faster.
<a href="https://aws.amazon.com/cdk/"><a href="https://aws.amazon.com/cdk/" target="_blank" rel="noopener">https://aws.amazon.com/cdk/</a>
</a></p>
</blockquote>
<p>In summary, we don&rsquo;t have to directly deal with CloudFormation or SAM for deploying our application. We will provision our cloud resources using a higher level framework called CDK which will ultimately translate into a CloudFormation template.</p>
<p>We should be able to see the advantages of using CDK very soon but let&rsquo;s look at this conversation to get some understanding of CDK.</p>

    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
      <iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="allowfullscreen" loading="eager" referrerpolicy="strict-origin-when-cross-origin" src="https://www.youtube.com/embed/W8sibGJnHEM?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" title="YouTube video"></iframe>
    </div>

<p>Let&rsquo;s begin now.</p>
<h3 id="step-1-setting-up-the-project">Step 1: Setting up the project</h3>
<p>We will be using the same project which was pushed <a href="https://github.com/aws-articles/serverless-order-service" target="_blank" rel="noopener">here</a>
.</p>
<ul>
<li>Install CDK globally by executing <code>npm install aws-cdk -g</code></li>
<li>Create a directory named <code>infra</code> inside our project <code>serverless-order-service</code></li>
<li>Execute <code>cdk init app --language=typescript</code> inside the <code>infra</code> directory</li>
</ul>
<p>This should generate a project that uses <code>typescript</code> as the programming language and <code>jest</code> as a testing framework. Let&rsquo;s update the generated <code>jest.config.js</code>.</p>
<p>Below is how our <code>jest.config.js</code> will look like -</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span>module.exports <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;testMatch&#34;</span><span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;**/__tests__/**/*.+(ts|tsx|js)&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;**/?(*.)+(spec|test).+(ts|tsx|js)&#34;</span>
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;transform&#34;</span><span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;^.+\\.(ts|tsx)$&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;ts-jest&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><img src="/project-setup-cdk.png" />
<p>If all has gone well so far this how our project structure will look like -</p>
<ul>
<li><code>infra-stack.ts</code> defines a class called <code>InfraStack</code> which is going to be a logical collection of various constructs like lambda function(s), dynamodb etc</li>
<li><code>infra.ts</code> is the entry point of the application that creates an instance of <code>InfraStack</code></li>
<li><code>infra.test.ts</code> contains a simple test to assert an empty stack</li>
<li><code>package.json</code> contains the project definition along with various dependencies including <code>@aws-cdk/assert</code> which is a library for asserting various cloud resources</li>
<li><code>jest.config.js </code>contains the necessary configuration to run jest tests</li>
<li><code>cdk.json</code> contains the command to run cdk application</li>
</ul>
<p>Let&rsquo;s make a few quick changes to the file names to match our convention, run the test and commit the changes:</p>
<ul>
<li>Rename <code>infra.ts</code> to <code>OrderServiceInfra.ts</code></li>
<li>Rename <code>infra-stack.ts</code> to <code>OrderServiceInfraStack.ts</code></li>
<li>Rename <code>infra.test.ts</code> to <code>OrderServiceInfraStack.spec.ts</code></li>
</ul>
<h3 id="step-2-creating-stack-with-the-lambda-function">Step 2: Creating stack with the lambda function</h3>
<p>Let&rsquo;s provision our lambda function. In order to do so we need to add a dependency <code>@aws-cdk/aws-lambda</code>. So, let&rsquo;s add it by executing <code>npm install @aws-cdk/aws-lambda@1.19.0</code>.</p>
<p>We will start by creating a lambda function construct inside <code>OrderServiceInfraStack</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">as</span> cdk <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/core&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {<span style="color:#8be9fd;font-style:italic">Function</span>} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/aws-lambda&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> OrderServiceInfraStack <span style="color:#ff79c6">extends</span> cdk.Stack {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">constructor</span>(scope: <span style="color:#8be9fd">cdk.Construct</span>, id: <span style="color:#8be9fd">string</span>, props?: <span style="color:#8be9fd">cdk.StackProps</span>) {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">super</span>(scope, id, props);
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">//create a lambda function in the stack
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">new</span> <span style="color:#8be9fd;font-style:italic">Function</span>(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#34;order-service-function&#34;</span>, <span style="color:#ff79c6">null</span>); <span style="color:#6272a4">//compilation error
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Few quick observations:</p>
<ul>
<li>
<p>We have imported Function class from <code>@aws-cdk/aws-lambda</code></p>
</li>
<li>
<p>Constructor of Function class takes 3 parameters:</p>
<ul>
<li><code>scope: Construct</code> - which identifies the parent resource</li>
<li><code>id: string</code> - unique identifier of the resource within the stack</li>
<li><code>props: FunctionProps</code> - lambda function properties including name, runtime, handler etc</li>
</ul>
</li>
<li>
<p>Typescript compiler gives an error because null is not acceptable in place of <code>FunctionProps</code></p>
</li>
</ul>
<p>Let&rsquo;s pass the required function properties -</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Code, <span style="color:#8be9fd;font-style:italic">Function</span>, FunctionProps, Runtime} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/aws-lambda&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Construct, Stack, StackProps} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/core&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> OrderServiceInfraStack <span style="color:#ff79c6">extends</span> Stack {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">constructor</span>(scope: <span style="color:#8be9fd">Construct</span>, id: <span style="color:#8be9fd">string</span>, props?: <span style="color:#8be9fd">StackProps</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">super</span>(scope, id, props);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">//create FunctionProps
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">const</span> functionProperties: <span style="color:#8be9fd">FunctionProps</span> <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>            code: <span style="color:#8be9fd">Code.fromAsset</span>(<span style="color:#f1fa8c">&#34;../dist&#34;</span>),
</span></span><span style="display:flex;"><span>            handler<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;handler.ordersHandler&#34;</span>,
</span></span><span style="display:flex;"><span>            runtime: <span style="color:#8be9fd">Runtime.NODEJS_10_X</span>,
</span></span><span style="display:flex;"><span>            functionName<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;order-service-function&#34;</span>,
</span></span><span style="display:flex;"><span>            environment<span style="color:#ff79c6">:</span> {<span style="color:#f1fa8c">&#34;ExecutionEnvironment&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;dev&#34;</span>}
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">//create a lambda function in the stack
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">new</span> <span style="color:#8be9fd;font-style:italic">Function</span>(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#34;order-service-function&#34;</span>, functionProperties);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here, the code, handler and the runtime are the only mandatory properties. Passing them should make the compiler happy.</p>
<p>With this change in the <code>OrderServiceInfraStack</code>, our test will break because it asserts for empty resources inside the stack but now the stack contains a lambda function. We will fix the test in a moment.</p>
<p>Quick observations:</p>
<ul>
<li>We are passing the <code>ExecutionEnvironment</code> as lambda environment variable. This variable is used to determine if the lambda is running in the test mode or the production mode. This value can also be taken as deployment parameter, but for now we are passing it as dev</li>
<li>We have used <code>../dist </code>inside code asset which contains our transpiled code</li>
</ul>
<h3 id="step-3-fixing-the-test">Step 3: Fixing the test</h3>
<p>CDK allows us to write different forms of tests including snapshot tests and fine-grained unit tests. We will be writing both the tests - snapshot test(s) for our entire stack and unit tests for resources like lambda function, DynamoDB and API gateway etc.</p>
<p>We will be starting with unit tests which will assert on a resource and its properties.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {OrderServiceInfraStack} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../lib/OrderServiceInfraStack&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {App} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/core&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Runtime} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/aws-lambda&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;@aws-cdk/assert/jest&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>test(<span style="color:#f1fa8c">&#34;stack should contain a lambda function with node10 as the runtime&#34;</span>, () <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> app <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> App();
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> stack <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> OrderServiceInfraStack(app, <span style="color:#f1fa8c">&#34;OrderServiceStack&#34;</span>); <span style="color:#6272a4">//instantiate stack
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//assert that stack contains a lambda function with node10 as the runtime
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    expect(stack).toHaveResource(<span style="color:#f1fa8c">&#34;AWS::Lambda::Function&#34;</span>, {
</span></span><span style="display:flex;"><span>        Runtime: <span style="color:#8be9fd">Runtime.NODEJS_10_X.toString</span>()
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>Few quick observations:</p>
<ul>
<li>We have imported <code>aws-cdk/assert/jest</code> that provides us with <code>expect</code> function that allows us to match resources in the stack</li>
<li>Our unit test asserts only on lambda&rsquo;s runtime property</li>
</ul>
<p>That&rsquo;s it. Our lambda function resource is created in the stack, and we have been able to write a unit test. Let&rsquo;s commit the changes.</p>
<h3 id="step-4-adding-dynamodb-to-the-stack">Step 4: Adding DynamoDB to the stack</h3>
<p>Let&rsquo;s provision DynamoDB. In order to do so we need to add a dependency <code>@aws-cdk/aws-dynamodb</code>. So, let&rsquo;s add it by executing <code>npm install @aws-cdk/aws-dynamodb@1.19.0</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Code, <span style="color:#8be9fd;font-style:italic">Function</span>, FunctionProps, Runtime} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/aws-lambda&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Construct, Stack, StackProps} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/core&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {AttributeType, Table, TableProps} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/aws-dynamodb&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> OrderServiceInfraStack <span style="color:#ff79c6">extends</span> Stack {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">constructor</span>(scope: <span style="color:#8be9fd">Construct</span>, id: <span style="color:#8be9fd">string</span>, props?: <span style="color:#8be9fd">StackProps</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">super</span>(scope, id, props);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">const</span> functionProperties: <span style="color:#8be9fd">FunctionProps</span> <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>            code: <span style="color:#8be9fd">Code.fromAsset</span>(<span style="color:#f1fa8c">&#34;../dist&#34;</span>),
</span></span><span style="display:flex;"><span>            handler<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;handler.ordersHandler&#34;</span>,
</span></span><span style="display:flex;"><span>            runtime: <span style="color:#8be9fd">Runtime.NODEJS_10_X</span>,
</span></span><span style="display:flex;"><span>            functionName<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;order-service-function&#34;</span>,
</span></span><span style="display:flex;"><span>            environment<span style="color:#ff79c6">:</span> {<span style="color:#f1fa8c">&#34;ExecutionEnvironment&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;dev&#34;</span>}
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> <span style="color:#8be9fd;font-style:italic">Function</span>(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#34;order-service-function&#34;</span>, functionProperties);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">//create TableProps
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">const</span> tableProps: <span style="color:#8be9fd">TableProps</span> <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>            partitionKey<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>                name<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;orderId&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">type</span><span style="color:#ff79c6">:</span> AttributeType.STRING
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            tableName<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;orders&#34;</span>
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">//create a dynamo table in the stack
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">new</span> Table(<span style="color:#ff79c6">this</span>, <span style="color:#f1fa8c">&#34;order-table&#34;</span>, tableProps);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Few quick observations:</p>
<ul>
<li>We have imported the <code>Table</code> class from <code>@aws-cdk/aws-dynamodb</code></li>
<li>Constructor of the <code>Table</code> class takes 3 parameters:
<ul>
<li><code>scope: Construct</code> - which identifies the parent resource</li>
<li><code>id: string</code> - unique identifier of the resource within the stack</li>
<li><code>props: TableProps</code> - table properties including name of the table, partitionKey etc.</li>
</ul>
</li>
</ul>
<p>That&rsquo;s it. Our DynamoDB table resource is created in the stack. Let&rsquo;s verify by writing a unit test.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span>test(<span style="color:#f1fa8c">&#34;stack should contain a dynamodb table with table name&#34;</span>, () <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> app <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> App();
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> stack <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> OrderServiceInfraStack(app, <span style="color:#f1fa8c">&#34;OrderServiceStack&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//assert that stack contains a dynamo table with &#34;orders&#34; as the table name
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    expect(stack).toHaveResource(<span style="color:#f1fa8c">&#34;AWS::DynamoDB::Table&#34;</span>, {
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;TableName&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;orders&#34;</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>test(<span style="color:#f1fa8c">&#34;stack should contain a dynamodb table with orderId as the Hash key&#34;</span>, () <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> app <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> App();
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> stack <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> OrderServiceInfraStack(app, <span style="color:#f1fa8c">&#34;OrderServiceStack&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//assert that stack contains a dynamo table with &#34;orderId&#34; as the HASH key
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    expect(stack).toHaveResource(<span style="color:#f1fa8c">&#34;AWS::DynamoDB::Table&#34;</span>, {
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;KeySchema&#34;</span><span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;AttributeName&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;orderId&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;KeyType&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;HASH&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><h3 id="step-5-refactoring-the-stack">Step 5: Refactoring the stack</h3>
<p>Let&rsquo;s look at a unit test and see if there are any challenges in understanding it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span>test(<span style="color:#f1fa8c">&#34;stack should contain a lambda function with node10 as runtime&#34;</span>, () <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> app <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> App();
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> stack <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> OrderServiceInfraStack(app, <span style="color:#f1fa8c">&#34;OrderServiceStack&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    expect(stack).toHaveResource(<span style="color:#f1fa8c">&#34;AWS::Lambda::Function&#34;</span>, {
</span></span><span style="display:flex;"><span>        Runtime: <span style="color:#8be9fd">Runtime.NODEJS_10_X.toString</span>()
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><ul>
<li>How do you know our stack will contain a lambda function with <code>node10</code> as the runtime? Honestly, there is no relation between the test input and its output</li>
<li>Even though the test is for <code>OrderServiceStack</code>, I see that we are trying to assert on properties of a resource. It somehow looks to me like a misplaced test</li>
</ul>
<p>In order to solve both the problems, we can create a component (or a class) that accepts configuration properties and creates a lambda function. This means we will be able to move lambda function unit tests closer to that class and make the unit tests more revealing. Let&rsquo;s see how.</p>
<p>Let&rsquo;s consider that all our lambda functions are based on <code>node10</code> runtime. With this consideration, we can create a class, <code>Node10LambdaFunction</code> that represents a lambda function and accepts <code>Node10LambdaFunctionProperties</code>.</p>
<p><em>This is the way which we will take in the article, you should try other approaches and please share them.</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Code, <span style="color:#8be9fd;font-style:italic">Function</span>, FunctionProps, Runtime} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/aws-lambda&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Construct} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/core&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//inherit from Function
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> Node10LambdaFunction <span style="color:#ff79c6">extends</span> <span style="color:#8be9fd;font-style:italic">Function</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//accepts Node10FunctionProperties which will contain attributes that make sense for our project
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">constructor</span>(scope: <span style="color:#8be9fd">Construct</span>, properties: <span style="color:#8be9fd">Node10FunctionProperties</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">super</span>(scope, properties.functionName, properties.toFunctionProps())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> Node10LambdaFunctionProperties {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//attributes that make sense at this stage
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">constructor</span>(<span style="color:#ff79c6">private</span> <span style="color:#ff79c6">readonly</span> code: <span style="color:#8be9fd">Code</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">private</span> <span style="color:#ff79c6">readonly</span> handler: <span style="color:#8be9fd">string</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">readonly</span> functionName: <span style="color:#8be9fd">string</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">private</span> <span style="color:#ff79c6">readonly</span> environmentVariables<span style="color:#ff79c6">?:</span> {[key: <span style="color:#8be9fd">string</span>]<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span> }) {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//behavior to return AWS FunctionProps
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    toFunctionProps()<span style="color:#ff79c6">:</span> FunctionProps {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> {
</span></span><span style="display:flex;"><span>            code: <span style="color:#8be9fd">this.code</span>,
</span></span><span style="display:flex;"><span>            handler: <span style="color:#8be9fd">this.handler</span>,
</span></span><span style="display:flex;"><span>            runtime: <span style="color:#8be9fd">Runtime.NODEJS_10_X</span>,
</span></span><span style="display:flex;"><span>            functionName: <span style="color:#8be9fd">this.functionName</span>,
</span></span><span style="display:flex;"><span>            environment: <span style="color:#8be9fd">this.environmentVariables</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Few quick observations:</p>
<ul>
<li>Client of <code>Node10LambdaFunction</code> (which is going be our stack now) is not required to pass runtime as it is evident from the name itself</li>
<li>Client code is not required to pass the <code>id</code> of the resource. <code>Node10LambdaFunction</code> passes function name as the id of the resource</li>
</ul>
<p>Now, we can move the lambda function unit tests closer to <code>Node10LambdaFunction</code>. This is how the updated test(s) will look like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span>test(<span style="color:#f1fa8c">&#34;stack should contain a lambda function with node10 as runtime&#34;</span>, () <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> stack <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Stack();
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> properties <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Node10LambdaFunctionProperties(
</span></span><span style="display:flex;"><span>        Code.fromAsset(<span style="color:#f1fa8c">&#34;../dist&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;handler.ordersHandler&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;order-service-function&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//name of the class indicates a lambda function with node10 as the runtime will be created
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">new</span> Node10LambdaFunction(stack, properties);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//assert that stack contains a lambda function with node10 as the runtime. This time the test is not magical
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    expect(stack).toHaveResource(<span style="color:#f1fa8c">&#34;AWS::Lambda::Function&#34;</span>, {
</span></span><span style="display:flex;"><span>        Runtime: <span style="color:#8be9fd">Runtime.NODEJS_10_X.toString</span>()
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>test(<span style="color:#f1fa8c">&#34;stack should contain a lambda function with specified environment variable&#34;</span>, () <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> stack <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Stack();
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> properties <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Node10LambdaFunctionProperties(
</span></span><span style="display:flex;"><span>        Code.fromAsset(<span style="color:#f1fa8c">&#34;../dist&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;handler.ordersHandler&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;order-service-function&#34;</span>,
</span></span><span style="display:flex;"><span>        {<span style="color:#f1fa8c">&#34;env&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;dev&#34;</span>}
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">new</span> Node10LambdaFunction(stack, properties);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//assert that stack contains a lambda function with provided environment variable
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    expect(stack).toHaveResource(<span style="color:#f1fa8c">&#34;AWS::Lambda::Function&#34;</span>, {
</span></span><span style="display:flex;"><span>        Environment<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>            Variables<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;env&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;dev&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>Here, we are not instantiating <code>OrderServiceStack</code> but creating an empty stack which gets passed to <code>Node10LambdaFunction</code>.</p>
<p>Similarly, we can write other tests around lambda function like: assert that lambda function is created with a given name, assert that lambda function is inside a VPC etc. <em>I will make similar changes for the Dynamo table and commit the code.</em></p>
<p>With these changes, we can write unit tests for various components (as fine-grained as we want) and a snapshot test for the entire stack.</p>
<h3 id="step-6-adding-lambda-backed-public-rest-api-to-the-stack">Step 6: Adding lambda backed public REST API to the stack</h3>
<p>Let&rsquo;s provision a REST API. In order to do so we need to add a dependency <code>@aws-cdk/aws-apigateway</code>. So, let&rsquo;s add it by executing <code>npm install @aws-cdk/aws-apigateway@1.19.0</code>.</p>
<p>Following the same pattern we would like to create a class that allows us to add an endpoint that can be accessed publicly and is backed by a lambda function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {LambdaRestApi, LambdaRestApiProps, MethodLoggingLevel} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/aws-apigateway&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Construct} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/core&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Node10LambdaFunction} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../../function/Node10LambdaFunction&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {IFunction} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/aws-lambda&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//inherit from LambdaRestApi
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">class</span> LambdaBackedPublicRestApi <span style="color:#ff79c6">extends</span> LambdaRestApi {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//similar to Node10Function, it accepts LambdaBackedPublicRestApiProperties
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">constructor</span>(scope: <span style="color:#8be9fd">Construct</span>, properties: <span style="color:#8be9fd">LambdaBackedPublicRestApiProperties</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">super</span>(scope, properties.apiName, properties.toLambdaRestApiProps());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> LambdaBackedPublicRestApiProperties {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">constructor</span>(<span style="color:#ff79c6">readonly</span> apiName: <span style="color:#8be9fd">string</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">private</span> <span style="color:#ff79c6">readonly</span> stageName: <span style="color:#8be9fd">string</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">private</span> handler: <span style="color:#8be9fd">Node10LambdaFunction</span>) {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//behavior to return LambdaRestApiProps
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    toLambdaRestApiProps()<span style="color:#ff79c6">:</span> LambdaRestApiProps {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> {
</span></span><span style="display:flex;"><span>            restApiName: <span style="color:#8be9fd">this.apiName</span>,
</span></span><span style="display:flex;"><span>            deployOptions<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>                stageName: <span style="color:#8be9fd">this.stageName</span>,
</span></span><span style="display:flex;"><span>                loggingLevel: <span style="color:#8be9fd">MethodLoggingLevel.INFO</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            proxy: <span style="color:#8be9fd">false</span>,
</span></span><span style="display:flex;"><span>            handler: <span style="color:#8be9fd">this.handler</span> <span style="color:#ff79c6">as</span> IFunction
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This will create a REST API in the stack for us but there is no endpoint available for us. In order to allow that to happen we can expose a method that takes a resource path say - <code>orders/{orderId}</code> and a http method which needs to be attached to the last part of resource which in this example is <code>{orderId}</code>.</p>
<p>So, let&rsquo;s do this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {
</span></span><span style="display:flex;"><span>    LambdaRestApi,
</span></span><span style="display:flex;"><span>    LambdaRestApiProps,
</span></span><span style="display:flex;"><span>    MethodLoggingLevel,
</span></span><span style="display:flex;"><span>    Resource
</span></span><span style="display:flex;"><span>} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/aws-apigateway&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Construct} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/core&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Node10LambdaFunction} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../../function/Node10LambdaFunction&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {IFunction} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/aws-lambda&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> LambdaBackedPublicRestApi <span style="color:#ff79c6">extends</span> LambdaRestApi {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">constructor</span>(scope: <span style="color:#8be9fd">Construct</span>, properties: <span style="color:#8be9fd">LambdaBackedPublicRestApiProperties</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">super</span>(scope, properties.apiName, properties.toLambdaRestApiProps());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//add resource say, orders/{orderId} and a method GET against {orderId}
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    addEndpoint(resourcePath: <span style="color:#8be9fd">string</span>, httpMethod: <span style="color:#8be9fd">HttpMethod</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (resourcePath.startsWith(<span style="color:#f1fa8c">&#34;/&#34;</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> IllegalArgumentException(
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span>resourcePath<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c"> should not begin with a / while adding a rest endpoint`</span>
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">const</span> resource <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.addAllResourcesUsing(resourcePath);
</span></span><span style="display:flex;"><span>        resource.addMethod(httpMethod);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//add resources recursively
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">private</span> addAllResourcesUsing(resourcePath: <span style="color:#8be9fd">string</span>)<span style="color:#ff79c6">:</span> Resource {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">function</span> add(resources: <span style="color:#8be9fd">string</span>[], rootResource: <span style="color:#8be9fd">Resource</span>)<span style="color:#ff79c6">:</span> Resource {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> (resources.length <span style="color:#ff79c6">===</span> <span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> rootResource;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">else</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> add(
</span></span><span style="display:flex;"><span>                    resources.slice(<span style="color:#bd93f9">1</span>, resources.length),
</span></span><span style="display:flex;"><span>                    LambdaBackedPublicRestApi.getOrAdd(resources[<span style="color:#bd93f9">0</span>], rootResource)
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> add(resourcePath.split(<span style="color:#f1fa8c">&#34;/&#34;</span>), (<span style="color:#ff79c6">this</span>.root <span style="color:#ff79c6">as</span> Resource));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//return the already added resource or add
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">private</span> <span style="color:#ff79c6">static</span> getOrAdd(resourcePath: <span style="color:#8be9fd">string</span>, rootResource: <span style="color:#8be9fd">Resource</span>)<span style="color:#ff79c6">:</span> Resource {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">const</span> alreadyPresentResource <span style="color:#ff79c6">=</span> rootResource.getResource(resourcePath) <span style="color:#ff79c6">as</span> Resource;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> alreadyPresentResource <span style="color:#ff79c6">||</span> rootResource.addResource(resourcePath)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">enum</span> HttpMethod {
</span></span><span style="display:flex;"><span>  GET <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;GET&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> IllegalArgumentException <span style="color:#ff79c6">extends</span> <span style="color:#8be9fd;font-style:italic">Error</span> {}
</span></span></code></pre></div><p>Few quick observations -</p>
<ul>
<li>We do not expect the resource path to begin with a &ldquo;/&rdquo;, <code>aws-apigateway</code> throws an error if that is the case</li>
<li>We are recursively adding each resource from the resource path</li>
<li>HTTP method gets added on the last resource of the resource path</li>
<li><code>getOrAdd</code> ensures that we do not add the same resource again. Eg; if we want to add 2 resource paths <code>serverless/lambda</code> and <code>serverless/lambda/{functionId}</code>, it is necessary to ensure we do not add <code>serverless/lambda</code> again</li>
</ul>
<p>Let&rsquo;s quickly add a couple of unit tests.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {LambdaBackedPublicRestApi} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../../../lib/restapi/public/LambdaBackedPublicRestApi&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Stack} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/core&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {LambdaBackedPublicRestApiProperties} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../../../lib/restapi/public/LambdaBackedPublicRestApiProperties&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Node10LambdaFunctionProperties} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../../../lib/function/Node10LambdaFunctionProperties&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Code} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/aws-lambda&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Node10LambdaFunction} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../../../lib/function/Node10LambdaFunction&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {HttpMethod} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../../../lib/restapi/public/HttpMethod&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {CfnMethod} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/aws-apigateway&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;@aws-cdk/assert/jest&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> addFakeEndpoint <span style="color:#ff79c6">=</span> (api: <span style="color:#8be9fd">LambdaBackedPublicRestApi</span>) <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    api.addEndpoint(<span style="color:#f1fa8c">&#34;fake&#34;</span>, HttpMethod.GET);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>test(<span style="color:#f1fa8c">&#34;stack should contain a public api with a name&#34;</span>, () <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> stack <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Stack();
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> node10LambdaFunction <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Node10LambdaFunction(
</span></span><span style="display:flex;"><span>        stack,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> Node10LambdaFunctionProperties(
</span></span><span style="display:flex;"><span>        Code.fromAsset(<span style="color:#f1fa8c">&#34;../dist&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;handler.ordersHandler&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;order-service-function&#34;</span>)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> properties <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LambdaBackedPublicRestApiProperties(
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;orders-api&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;dev&#34;</span>,
</span></span><span style="display:flex;"><span>        node10LambdaFunction
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> api <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LambdaBackedPublicRestApi(stack, properties);
</span></span><span style="display:flex;"><span>    addFakeEndpoint(api);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//assert that stack contains a rest api with &#34;orders-api&#34; as the name
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    expect(stack).toHaveResource(<span style="color:#f1fa8c">&#34;AWS::ApiGateway::RestApi&#34;</span>, {
</span></span><span style="display:flex;"><span>        Name<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;orders-api&#34;</span>
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>test(<span style="color:#f1fa8c">&#34;stack should contain a public api with an http method GET added to the resource&#34;</span>, () <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> stack <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Stack();
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> node10LambdaFunction <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Node10LambdaFunction(
</span></span><span style="display:flex;"><span>        stack,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> Node10LambdaFunctionProperties(
</span></span><span style="display:flex;"><span>        Code.fromAsset(<span style="color:#f1fa8c">&#34;../dist&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;handler.ordersHandler&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;order-service-function&#34;</span>)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> properties <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LambdaBackedPublicRestApiProperties(
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;orders-api&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;dev&#34;</span>,
</span></span><span style="display:flex;"><span>        node10LambdaFunction
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> api <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LambdaBackedPublicRestApi(stack, properties);
</span></span><span style="display:flex;"><span>    api.addEndpoint(<span style="color:#f1fa8c">&#34;article/serverless&#34;</span>, HttpMethod.GET);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//get a resource and a CfnMethod against that resource
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">const</span> serverlessResource <span style="color:#ff79c6">=</span> api.root.getResource(<span style="color:#f1fa8c">&#34;article&#34;</span>)<span style="color:#ff79c6">?</span>.getResource(<span style="color:#f1fa8c">&#34;serverless&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> method <span style="color:#ff79c6">=</span> serverlessResource<span style="color:#ff79c6">?</span>.node.findChild(<span style="color:#f1fa8c">&#34;GET&#34;</span>) <span style="color:#ff79c6">as</span> CfnMethod;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    expect(method.httpMethod).toEqual(HttpMethod.GET);
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p><em>These tests assert that a REST API exists with a given name and a http method is attached to a resource.</em></p>
<h3 id="step-7-updating-the-stack">Step 7: Updating the stack</h3>
<p>Let&rsquo;s update the stack to have lambda function, DynamoDB table, lambda backed public api and DynamoDB table read access to lambda function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Code} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/aws-lambda&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Construct, Stack, StackProps} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/core&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {AttributeType} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/aws-dynamodb&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Node10LambdaFunction} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;./function/Node10LambdaFunction&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Node10LambdaFunctionProperties} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;./function/Node10LambdaFunctionProperties&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {DynamoTable} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;./dynamodb/DynamoTable&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {DynamoTableProperties} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;./dynamodb/DynamoTableProperties&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {PrimaryKey} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;./dynamodb/PrimaryKey&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {PartitionKey} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;./dynamodb/PartitionKey&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {LambdaBackedPublicRestApi} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;./restapi/public/LambdaBackedPublicRestApi&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {LambdaBackedPublicRestApiProperties} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;./restapi/public/LambdaBackedPublicRestApiProperties&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {HttpMethod} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;./restapi/public/HttpMethod&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> OrderServiceInfraStack <span style="color:#ff79c6">extends</span> Stack {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">constructor</span>(scope: <span style="color:#8be9fd">Construct</span>, id: <span style="color:#8be9fd">string</span>, props?: <span style="color:#8be9fd">StackProps</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">super</span>(scope, id, props);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">//use the newly prepared classes
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">const</span> ordersFunction <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.ordersFunction();
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">const</span> ordersTable    <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.ordersTable();
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">const</span> restApi        <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.lambdaBackedPublicRestApi(ordersFunction);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        restApi.addEndpoint(<span style="color:#f1fa8c">&#34;orders/{orderId}&#34;</span>, HttpMethod.GET); <span style="color:#6272a4">//add the required resources along with HTTP method
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        ordersTable.grantReadData(ordersFunction); <span style="color:#6272a4">//grant read access on &#34;orders&#34; table to lambda function
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//returns an instance of Node10LambdaFunction
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">private</span> ordersFunction() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Node10LambdaFunction(<span style="color:#ff79c6">this</span>, <span style="color:#ff79c6">new</span> Node10LambdaFunctionProperties(
</span></span><span style="display:flex;"><span>            Code.fromAsset(<span style="color:#f1fa8c">&#34;../dist&#34;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;handler.ordersHandler&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;order-service-function&#34;</span>,
</span></span><span style="display:flex;"><span>            {<span style="color:#f1fa8c">&#34;ExecutionEnvironment&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;dev&#34;</span>})
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//returns an instance of DynamoTable
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">private</span> ordersTable() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> DynamoTable(<span style="color:#ff79c6">this</span>, <span style="color:#ff79c6">new</span> DynamoTableProperties(
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;orders&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">new</span> PrimaryKey(
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">new</span> PartitionKey(
</span></span><span style="display:flex;"><span>                    <span style="color:#f1fa8c">&#34;orderId&#34;</span>,
</span></span><span style="display:flex;"><span>                    AttributeType.STRING)
</span></span><span style="display:flex;"><span>            ))
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//returns an instance of LambdaBackedPublicRestApi
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">private</span> lambdaBackedPublicRestApi(lambda: <span style="color:#8be9fd">Node10LambdaFunction</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> LambdaBackedPublicRestApi(<span style="color:#ff79c6">this</span>, <span style="color:#ff79c6">new</span> LambdaBackedPublicRestApiProperties(
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;orders-api&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;dev&#34;</span>,
</span></span><span style="display:flex;"><span>            lambda
</span></span><span style="display:flex;"><span>        ));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Time to add our snapshot test, probably simpler than you might have thought of:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {OrderServiceInfraStack} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../lib/OrderServiceInfraStack&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {App} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/core&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;@aws-cdk/assert/jest&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>test(<span style="color:#f1fa8c">&#34;should create order service stack&#34;</span>, () <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> app <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> App();
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> stack <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> OrderServiceInfraStack(app, <span style="color:#f1fa8c">&#34;OrderServiceStack&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    expect(stack).toMatchSnapshot();
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><h3 id="step-8-deploying-our-stack">Step 8: Deploying our stack</h3>
<p>We have worked hard to create all the resources that are needed in our stack. Now is the time to deploy our stack and see things in action.</p>
<p>Let&rsquo;s update <code>OrderServiceInfra</code> to pass stack name as a part of stack properties. It is this file which acts as an entry point for the application and is referred in <code>cdk.json</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span>#<span style="color:#ff79c6">!</span>/usr/bin/env node
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;source-map-support/register&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {OrderServiceInfraStack} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../lib/OrderServiceInfraStack&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {StackProps} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;@aws-cdk/core&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> cdk <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">require</span>(<span style="color:#f1fa8c">&#34;@aws-cdk/core&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> app <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> cdk.App();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//pass stack name
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">const</span> stackProps:<span style="color:#8be9fd">StackProps</span> <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>  stackName<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;order-service-stack&#34;</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//instantiate OrderServiceInfraStack
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">new</span> OrderServiceInfraStack(app, <span style="color:#f1fa8c">&#34;OrderServiceStack&#34;</span>, stackProps);
</span></span></code></pre></div><p>CDK also provides us with various commands -</p>
<ul>
<li><code>cdk list</code>- lists the stacks</li>
<li><code>cdk deploy</code>- deploys the stack in AWS environment</li>
<li><code>cdk destroy</code>- destroys the stacks</li>
<li><code>cdk synthesize</code>- synthesizes and prints the CloudFormation</li>
<li><code>cdk bootstrap</code>- deploys the CDK toolkit stack into an AWS environment</li>
</ul>
<p>We need to execute <code>cdk bootrap</code> and <code>cdk deploy</code> from the <code>infra</code> directory to deploy stack in our AWS account.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt; <span style="color:#8be9fd;font-style:italic">cd</span> infra
</span></span><span style="display:flex;"><span>&gt; cdk bootstrap
</span></span><span style="display:flex;"><span>&gt; cdk deploy 
</span></span></code></pre></div><p>These commands make a few assumptions -</p>
<ul>
<li>AWS credentials are already configured on the host machine</li>
<li>AWS user has the right to create various AWS resources including IAM roles</li>
<li><code>dist/</code> directory which will be deployed on an S3 bucket (bootstrap creates for us) when we execute<code>cdk bootstrap</code>, already exists</li>
</ul>
<p>It will take sometime for stack to be created which will consist of <code>lambda function, DynamoDB table, API gateway and all the necessary IAM roles</code>.</p>
<p>Once our stack is created, make an entry in the <code>orders</code> table, hit the public API endpoint which will look like <code>https://rest-api-id.execute-api.ap-south-1.amazonaws.com/dev/orders/OrderId</code> and enjoy the output.</p>
<p>That&rsquo;s it, our stack is deployed and our application is up and running </p>
<h3 id="conclusion">Conclusion</h3>
<p>Relationship between CDK and CloudFormation can be summarised as -</p>
<img src="/cdk.png" class="align-center"/>
<p>In this article we were able to code our infra using CDK, write tests for our infra and deploy the same. Let&rsquo;s take a look at some advantages of using <a href="https://docs.aws.amazon.com/cdk/latest/guide/home.html" target="_blank" rel="noopener">CDK</a>
:</p>
<ul>
<li>Resources can be modeled in Object-Oriented manner</li>
<li>High level abstractions can be defined and published within the team or company</li>
<li>Infrastructure can be built as library</li>
<li>Infrastructure code can be tested</li>
<li>IDE&rsquo;s code completion can be leveraged</li>
<li>Programming language constructs like if statements, for-loops, etc. can be used when defining infrastructure</li>
</ul>
<p>We have finally come to end of our Serverless Journey series. Hope you enjoyed it.</p>

  </article>
<div class="tag-list-container">
    <div class="tag-list">
        
        <a class="button" href="">
            <p class="tag"><i class="fa fa-fw fa-tag"></i>AWS Lambda</p>
        </a>
        
        <a class="button" href="">
            <p class="tag"><i class="fa fa-fw fa-tag"></i>Serverless</p>
        </a>
        
        <a class="button" href="">
            <p class="tag"><i class="fa fa-fw fa-tag"></i>CDK</p>
        </a>
        
    </div>
</div>



<div class="px-2 mb-2">
  
  <script src="https://giscus.app/client.js"
    data-repo="SarthakMakhija/tech-lessons-comments"
    data-repo-id="R_kgDOJHu3mA"
    data-category="Announcements"
    data-category-id="DIC_kwDOJHu3mM4CUxhS"
    data-mapping="og:title"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="light"
    data-lang="en"
    crossorigin="anonymous"
    async>
  </script>
  
</div>



    </main><footer class="container p-6 mx-auto flex justify-between items-center">
  <span></span>

  <span class="text-base font-thin">
    
    tech-lessons.in  2020 / Powered by  <a class="font-bold" target="_blank" href="https://gohugo.io/">Hugo</a>
    
  </span>

  <span onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="p-1 cursor-pointer">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" stroke-width="1.5"
      stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M18 15l-6 -6l-6 6h12" />
    </svg>
  </span>
</footer>

<div class="search-ui absolute top-0 left-0 w-full h-full bg-white dark:bg-gray-800 hidden">
  <div class="container max-w-3xl mx-auto p-12">
    <div class="relative">
      <div class="my-4 text-center text-2xl font-bold">Search</div>

      <span class="p-2 absolute right-0 top-0 cursor-pointer close-search">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </span>
    </div>

    <input type="search" class="py-2 px-3 w-full dark:text-black border dark:border-transparent"
      placeholder="Enter search query" />

    <div class="search-results text-lg font-medium my-4 hidden">Results</div>
    <ul class="search-list my-2">

    </ul>

    <div class="no-results text-center my-8 hidden">
      <div class="text-xl font-semibold mb-2">No results found</div>
      <p class="font-light text-sm">Try adjusting your search query</p>
    </div>
  </div>
</div>





<script src="//localhost:1313/js/scripts.min.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-9KKTKFQ2CM"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-9KKTKFQ2CM');
        }
      </script>





<script>
  const mobileMenuButton = document.querySelector('.mobile-menu-button')
  const mobileMenu = document.querySelector('.mobile-menu')
  function toggleMenu() {
    mobileMenu.classList.toggle('hidden');
    mobileMenu.classList.toggle('flex');
  }
  if(mobileMenu && mobileMenuButton){
    mobileMenuButton.addEventListener('click', toggleMenu)
  }
</script>
</body>
</html>
