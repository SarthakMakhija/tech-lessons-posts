<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" href="/favicon.png">

  <title>
  Beginning Serverless Journey - tech-lessons.in
  </title>
  <meta name="description" content="Serverless is a paradigm that lays its foundations on the fact that &#34;We don&#39;t have to provision and manage servers&#34;. Let&#39;s begin our serverless journey which starts with building a serverless application. After we have built an application we will proceed with testing it using LocalStack and finally deploying it using AWS CDK" />
  <meta name="author" content="Sarthak Makhija" />
  
     <meta property="og:image" content="/beginning-serverless.webp" />
  <meta name="generator" content="Hugo 0.140.1"><link rel="stylesheet" href="/css/styles.css" />

  
  

  <meta property="og:url" content="//localhost:1313/en/blog/beginning_serverless_journey/">
  <meta property="og:site_name" content="tech-lessons.in">
  <meta property="og:title" content="Beginning Serverless Journey">
  <meta property="og:description" content="Serverless is a paradigm that lays its foundations on the fact that &#34;We don&#39;t have to provision and manage servers&#34;. Let&#39;s begin our serverless journey which starts with building a serverless application. After we have built an application we will proceed with testing it using LocalStack and finally deploying it using AWS CDK">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2020-03-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2020-03-10T00:00:00+00:00">
    <meta property="article:tag" content="AWS Lambda">
    <meta property="article:tag" content="Serverless">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Beginning Serverless Journey">
  <meta name="twitter:description" content="Serverless is a paradigm that lays its foundations on the fact that &#34;We don&#39;t have to provision and manage servers&#34;. Let&#39;s begin our serverless journey which starts with building a serverless application. After we have built an application we will proceed with testing it using LocalStack and finally deploying it using AWS CDK">

  
  <meta itemprop="name" content="Beginning Serverless Journey">
  <meta itemprop="description" content="Serverless is a paradigm that lays its foundations on the fact that &#34;We don&#39;t have to provision and manage servers&#34;. Let&#39;s begin our serverless journey which starts with building a serverless application. After we have built an application we will proceed with testing it using LocalStack and finally deploying it using AWS CDK">
  <meta itemprop="datePublished" content="2020-03-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2020-03-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="2721">
  <meta itemprop="keywords" content="AWS Lambda,Serverless">

  
</head>
<body class="dark:bg-gray-800 dark:text-white relative flex flex-col min-h-screen"><header class="container flex justify-between md:justify-between gap-4 flex-wrap p-6 mx-auto relative">
  <a href="//localhost:1313/en/" class="capitalize font-extrabold text-2xl">
    
    <img src="/logo.png" alt="tech-lessons.in" class="h-8 max-w-full" />
    
  </a>
  <button class="mobile-menu-button md:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <line x1="4" y1="8" x2="20" y2="8" />
      <line x1="4" y1="16" x2="20" y2="16" />
    </svg>
  </button>
  <ul class="mobile-menu absolute z-10 px-6 pb-6 md:p-0 top-full left-0 w-full md:w-auto md:relative hidden md:flex flex-col md:flex-row items-end md:items-center gap-4 lg:gap-6 bg-white dark:bg-gray-800">

    
    <li><a href="/en/">Home</a></li>
    
    <li><a href="/en/blog">Blogs</a></li>
    
    <li><a href="/en/page/about/">About Me</a></li>
    
    <li><a href="/en/page/projects/">My projects</a></li>
    

    

    
    <li class="grid place-items-center">
      <span class="open-search inline-block cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <circle cx="10" cy="10" r="7" />
          <line x1="21" y1="21" x2="15" y2="15" />
        </svg>
      </span>
    </li>
    

    
  </ul>
</header>
<main class="flex-1">
  
  

  
  <div class="relative max-w-5xl mx-auto px-4">
    <img src="/beginning-serverless.webp" class="rounded-lg shadow-sm w-full object-contain" />
    
    <figcaption class="font-extralight text-xs"><i>Background by Nick Fewings on Unsplash</i></figcaption>
    
    
    <div class="absolute top-4 right-8 rounded shadow bg-white text-gray-900 dark:bg-gray-900 dark:text-white px-2 py-0.5">
      
  
    March 10, 2020
  


    </div>
    
  </div>
  

  <article class="prose lg:prose-lg mx-auto my-8 dark:prose-dark px-4 max-w-5xl">

    <h1 class="text-2xl font-bold mb-2">Beginning Serverless Journey</h1>
    
    <h5 class="text-sm flex items-center flex-wrap">
      <svg xmlns="http://www.w3.org/2000/svg" class="mr-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <rect x="4" y="5" width="16" height="16" rx="2" />
        <line x1="16" y1="3" x2="16" y2="7" />
        <line x1="8" y1="3" x2="8" y2="7" />
        <line x1="4" y1="11" x2="20" y2="11" />
        <rect x="8" y="15" width="2" height="2" />
      </svg>
      Posted on 
  
    March 10, 2020
  


      
        &nbsp;&bull;&nbsp;
      
      <svg xmlns="http://www.w3.org/2000/svg" class="mr-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <circle cx="12" cy="12" r="9" />
        <polyline points="12 7 12 12 15 15" />
      </svg>
      13&nbsp;minutes
      &nbsp;&bull;
      <svg xmlns="http://www.w3.org/2000/svg" class="mx-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <path d="M3 19a9 9 0 0 1 9 0a9 9 0 0 1 9 0" />
        <path d="M3 6a9 9 0 0 1 9 0a9 9 0 0 1 9 0" />
        <line x1="3" y1="6" x2="3" y2="19" />
        <line x1="12" y1="6" x2="12" y2="19" />
        <line x1="21" y1="6" x2="21" y2="19" />
      </svg>
      2721&nbsp;words
      
    </h5>
    

    <details id="TableOfContents" class="px-4 mt-4 bg-gray-100 dark:bg-gray-700 rounded toc">
    <summary class="flex items-center font-bold py-2 px-4 cursor-pointer justify-between select-none text-black dark:text-white">
      <span>Table of contents</span>
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-down" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <polyline points="6 9 12 15 18 9"></polyline>
     </svg>
    </summary>

    <ul class="mt-2 pb-4">
        

        
        <li>
        <a href="#building-a-serverless-application">Building a Serverless application</a>
        

        
        </li><li>
        <a href="#step-1-setting-up-the-project">Step 1: Setting up the project</a>
        

        
        </li><li>
        <a href="#before-we-start-coding">Before we start coding</a>
        

        
        </li><li>
        <a href="#step-2-lets-start-with-the-lambda-handler">Step 2: Let&rsquo;s start with the lambda handler</a>
        

        
        </li><li>
        <a href="#step-3-lets-jump-into-controller">Step 3: Let&rsquo;s jump into controller</a>
        

        
        </li><li>
        <a href="#step-4-lets-jump-into-the-service">Step 4: Let&rsquo;s jump into the service</a>
        

        
        </li><li>
        <a href="#step-5-lets-jump-into-the-repository">Step 5: Let&rsquo;s jump into the repository</a>
        

        
        </li><li>
        <a href="#step-6-finishing-the-order-class">Step 6: Finishing the Order class</a>
        

        
        </li><li>
        <a href="#step-7-finishing-the-orderrequest-class">Step 7: Finishing the OrderRequest class</a>
        

        
        </li><li>
        <a href="#step-8-introducing-asyncawait-in-service-and-controller">Step 8: Introducing async/await in service and controller</a>
        

        
        </li><li>
        <a href="#step-9-lambda-response-with-api-gateway">Step 9: Lambda response with API gateway</a>
        

        
        </li><li>
        <a href="#step-10-adding-unit-tests">Step 10: Adding unit tests</a>
        

        
        </li><li>
        <a href="#controller-unit-tests">Controller unit tests</a>
        

        
        </li><li>
        <a href="#summary">Summary</a>
        </li></ul>
  </details>

    <blockquote>
<p>Serverless is a paradigm that lays its foundations on the fact that &ldquo;We don&rsquo;t have to provision and manage servers&rdquo;.
This article series explores various aspects involved in a serverless application lifecycle including - development, testing and deployment.
Our serverless journey which starts from building to deploying an application will be using multiple serverless components including AWS Lambda, AWS API Gateway, AWS DynamoDB, LocalStack and AWS CDK.</p>
</blockquote>
<p>Let us deep dive step by step into what it takes to build a Serverless application.</p>
<h3 id="building-a-serverless-application">Building a Serverless application</h3>
<p>Let&rsquo;s assume a hypothetical <em>Order Service</em> that allows creation of an order and its retrieval by <code>order id</code>.</p>
<p>As a part of this article we will be building just one part of this service that will expose a REST API to allow users to <em>find an order</em> by <em>orderId</em>.  Below diagram highlights different AWS components involved in finding an order by its id.</p>
<p><img class="align-center" src="/serverless-application.png" /></figure></p>
<p>We will be using TypeScript for writing our Serverless application. Why Typescript? For a few reasons:</p>
<ul>
<li>Short cold start time</li>
<li>Supports static typing and type inference</li>
<li>Existing Javascript libraries can be used with Typescript</li>
</ul>
<p>So, let&rsquo;s start building our application.</p>
<h3 id="step-1-setting-up-the-project">Step 1: Setting up the project</h3>
<p>Let&rsquo;s quickly set up our project:</p>
<ul>
<li>Install typescript globally by executing <code>npm install typescript -g</code></li>
<li>Create a directory named <code>serverless-order-service</code> representing our project</li>
<li>Execute <code>npm init -y</code> inside our project directory (<code>serverless-order-service</code>)</li>
<li>Add typescript as a dependency by executing <code>npm install typescript --save</code> inside our project directory</li>
</ul>
<p>As a final step, add <code>tsconfig.json</code> with a very simple configuration as mentioned below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;compilerOptions&#34;</span><span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;noEmitOnError&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;moduleResolution&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;node&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;module&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;commonjs&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;target&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;es6&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;outDir&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;dist&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;inlineSourceMap&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>That should be it. Our project set up is done, and we are ready to make our first commit.</p>
<h3 id="before-we-start-coding">Before we start coding</h3>
<p>Let&rsquo;s take a moment to think about the overall design of the project.</p>
<p>This application is a classic web application that involves a REST API, a database and an object representing the persistent state of order. With this very small context, I feel it would not be unfair to organise the project in <em>Model-View-Controller</em> fashion that means that execution of a user request will involve the following components:</p>
<img class="align-center" src="/lambda-flow.png" />
<h3 id="step-2-lets-start-with-the-lambda-handler">Step 2: Let&rsquo;s start with the lambda handler</h3>
<p>Lambda handler is a function that will be invoked by the <em>AWS Lambda Service</em> in the response to an event. An event could be - an object uploaded on an S3 bucket, an event on SQS or a https request via API gateway and many more. In our example a request to an API Gateway will be the event.</p>
<p>Before we start our lambda function let&rsquo;s install the type definition for aws-lambda by executing: <code>npm install @types/aws-lambda --save-dev</code> and create a commit.</p>
<p>After the dependency is installed we are ready to code our handler. Let&rsquo;s put this in a file named <code>handler.ts</code> under the <code>src</code> directory.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {APIGatewayEvent} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;aws-lambda&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">const</span> ordersHandler <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">async</span> (event: <span style="color:#8be9fd">APIGatewayEvent</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">any</span>&gt; <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//your code goes here
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>};
</span></span></code></pre></div><p>This is the simplest handler function that could be created at this stage. One thing to note is we are using the type <em>APIGatewayEvent</em> imported from <em>&ldquo;aws-lambda&rdquo;</em> to get type-safe events as parameter to handler function.</p></p>
<p>We want to keep our handler function as thin as possible, so we will delegate the request to a controller class which instead of taking <em>APIGatewayEvent</em> will take a domain object that wraps the <em>APIGatewayEvent</em>.</p>
<p>In this example, <em>OrderRequest</em> is that domain object, effectively a wrapper over <em>APIGatewayEvent</em>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {APIGatewayEvent} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;aws-lambda&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">const</span> ordersHandler <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">async</span> (event: <span style="color:#8be9fd">APIGatewayEvent</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">any</span>&gt; <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> OrderController().handle(<span style="color:#ff79c6">new</span> OrderRequest(event)); <span style="color:#6272a4">//handler invokes controller
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> OrderController {
</span></span><span style="display:flex;"><span>    handle(orderRequest: <span style="color:#8be9fd">OrderRequest</span>) { 
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">//accepts OrderRequest
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//domain object that wraps APIGatewayEvent
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> OrderRequest {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">constructor</span>(<span style="color:#ff79c6">private</span> <span style="color:#ff79c6">readonly</span> event: <span style="color:#8be9fd">APIGatewayEvent</span>) {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s move the <code>OrderController</code> and the <code>OrderRequest</code> classes to <code>controller</code> and <code>model</code> packages (or directories) respectively and invoke the <code>OrderController</code> from handler. This is how the handler function will look like after the classes have been moved.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {APIGatewayEvent} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;aws-lambda&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {OrderRequest}    <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;./model/OrderRequest&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {OrderController} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;./controller/OrderController&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">const</span> ordersHandler <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">async</span> (event: <span style="color:#8be9fd">APIGatewayEvent</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">any</span>&gt; <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> OrderController().handle(<span style="color:#ff79c6">new</span> OrderRequest(event));
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>I think we are ready to make our next commit. I know we haven&rsquo;t written any unit tests but as far as this article is concerned, we will write unit tests before we start the next article.</p>
<h3 id="step-3-lets-jump-into-controller">Step 3: Let&rsquo;s jump into controller</h3>
<p>Controller is a class that will handle the incoming request and return an appropriate response. By this definition, controller will be expected to accept an <code>OrderRequest</code> and find an order by its id.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {OrderRequest} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../model/OrderRequest&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> OrderController {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    handle(orderRequest: <span style="color:#8be9fd">OrderRequest</span>) {
</span></span><span style="display:flex;"><span>       <span style="color:#ff79c6">if</span> (orderRequest.isAGetOrder()) { <span style="color:#6272a4">//if the request is for finding an order
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>         <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.findAnOrderBy(orderRequest.orderId()); <span style="color:#6272a4">//find an order by its id
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>       }
</span></span><span style="display:flex;"><span>       <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">private</span> findAnOrderBy(id: <span style="color:#8be9fd">string</span>)<span style="color:#ff79c6">:</span> Order {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span>; <span style="color:#6272a4">//fake implementation
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> Order {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Few quick observations:</p>
<ul>
<li><code>OrderRequest</code> is the domain object that encapsulates the <code>APIGatewayEvent</code> and provides domain methods like <code>orderId()</code>, <code>isAGetOrder()</code> without exposing the <code>APIGatewayEvent</code>.</li>
<li>Currently, <code>orderId()</code> and <code>isAGetOrder()</code> methods of the <code>OrderRequest</code> return fixed (or fake) values.</li>
</ul>
<p>Let&rsquo;s make a few quick changes in the <code>OrderController</code>:</p>
<ul>
<li>Move the <code>Order</code> class in the <code>model</code> package</li>
<li>Invoke the service method to find an order by its id</li>
</ul>
<p>This is how different classes look at this stage.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#6272a4">//OrderController.ts
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">import</span> {OrderRequest} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../model/OrderRequest&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Order}        <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../model/Order&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {OrderService} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../service/OrderService&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> OrderController {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">private</span> orderService: <span style="color:#8be9fd">OrderService</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">constructor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.orderService <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> OrderService();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    handle(orderRequest: <span style="color:#8be9fd">OrderRequest</span>) {
</span></span><span style="display:flex;"><span>       <span style="color:#ff79c6">if</span> (orderRequest.isAGetOrder()) {
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.findAnOrderBy(orderRequest.orderId())
</span></span><span style="display:flex;"><span>       }
</span></span><span style="display:flex;"><span>       <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">private</span> findAnOrderBy(id: <span style="color:#8be9fd">string</span>)<span style="color:#ff79c6">:</span> Order {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.orderService.findAnOrderBy(id); <span style="color:#6272a4">//controller invokes service to find an order by its id
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//OrderRequest.ts
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">import</span> {APIGatewayEvent} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;aws-lambda&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> OrderRequest {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">constructor</span>(<span style="color:#ff79c6">private</span> <span style="color:#ff79c6">readonly</span> event: <span style="color:#8be9fd">APIGatewayEvent</span>) {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    isAGetOrder()<span style="color:#ff79c6">:</span> <span style="color:#ff79c6">boolean</span> {
</span></span><span style="display:flex;"><span>       <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span>; <span style="color:#6272a4">//fake implementation
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    }
</span></span><span style="display:flex;"><span>    orderId()<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>; <span style="color:#6272a4">//fake implementation
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//OrderService.ts
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> OrderService {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    findAnOrderBy(id: <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span>; <span style="color:#6272a4">//fake implementation
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="step-4-lets-jump-into-the-service">Step 4: Let&rsquo;s jump into the service</h3>
<p>The service layer will interact with the repository to find an order by id. It doesn&rsquo;t look like service layer is really needed for this example, but let&rsquo;s proceed with it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> OrderService {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">private</span> repository: <span style="color:#8be9fd">OrderRepository</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">constructor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.repository <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> OrderRepository();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    findAnOrderBy(id: <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.repository.findAnOrderBy(id); <span style="color:#6272a4">//service invokes repository to find an order by its id
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> OrderRepository {
</span></span><span style="display:flex;"><span>    findAnOrderBy(id: <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span>; <span style="color:#6272a4">//fake implementation
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s move OrderRepository into repository package.</p>
<h3 id="step-5-lets-jump-into-the-repository">Step 5: Let&rsquo;s jump into the repository</h3>
<p>The repository will interact with our database which in this example is a <code>DynamoDB</code> and fetch an order by its id. Let&rsquo;s assume a table named <em>orders</em> with <em>orderId</em> as the HASH key and an attribute named <em>amount</em>.</p>
<p>We will be using <em>aws-sdk</em> for querying <em>DynamoDB</em>. <em>aws-sdk</em> is a dependency that is available in the runtime environment of lambda which means this dependency can be added as a <em>devDependency</em>.</p>
<p>So, let&rsquo;s add it as a <em>devDependency</em> by executing <code>npm install aws-sdk --save-dev</code>. Let&rsquo;s also add the type definitions for <em>aws-sdk</em> by executing <code>npm install @types/aws-sdk --save-dev</code>.</p>
<p>Now we are ready to query the <em>orders</em> table.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {DynamoDB} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;aws-sdk&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {GetItemInput} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;aws-sdk/clients/dynamodb&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Order} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../model/Order&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> dynamoDb <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DynamoDB({
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;region&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;ap-south-1&#34;</span>
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> OrderRepository {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> findAnOrderBy(id: <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">const</span> getItemInputOptions: <span style="color:#8be9fd">GetItemInput</span> <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>            TableName<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;orders&#34;</span>, <span style="color:#6272a4">//table name
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>            Key<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;orderId&#34;</span><span style="color:#ff79c6">:</span> {S: <span style="color:#8be9fd">id</span>} <span style="color:#6272a4">//query against orderId attribute of order item
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>            }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">const</span> response <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> dynamoDb.getItem(getItemInputOptions).promise(); <span style="color:#6272a4">//get a dynamo item by passing its id
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">return</span> response.Item;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Few quick observations:</p>
<ul>
<li>We have hard-coded the region and table name, which we might want to fetch from configuration/properties for the below-mentioned reasons:
<ul>
<li><em>region</em> might be different for actual environment and integration testing (using localstack)</li>
<li>if there are multiple deployment environments and dynamo table name is different for each environment</li>
</ul>
</li>
<li>With DynamoDB the lowest level of abstraction is a table, hence, we might need different table name for each environment</li>
<li>Method name and return type of the method do not go hand-in-hand. We expect this method to return an order but this method seems to be returning some type specified by <code>response.Item</code></li>
</ul>
<p>Let&rsquo;s quickly make a change to return the <code>Order</code> instead of <code>response.Item</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {DynamoDB} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;aws-sdk&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {GetItemInput} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;aws-sdk/clients/dynamodb&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Order} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../model/Order&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> dynamoDb <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DynamoDB({
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;region&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;ap-south-1&#34;</span>
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> OrderRepository {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> findAnOrderBy(id: <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">const</span> getItemInputOptions: <span style="color:#8be9fd">GetItemInput</span> <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>            TableName<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;orders&#34;</span>, <span style="color:#6272a4">//table name
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>            Key<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;orderId&#34;</span><span style="color:#ff79c6">:</span> {S: <span style="color:#8be9fd">id</span>} <span style="color:#6272a4">//query against orderId attribute of order item
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>            }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">const</span> response <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> dynamoDb.getItem(getItemInputOptions).promise(); <span style="color:#6272a4">//get a dynamo item by passing its id
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">return</span> response.Item <span style="color:#ff79c6">?</span> Order.<span style="color:#ff79c6">from</span>(response.Item) <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">null</span>;  <span style="color:#6272a4">//map dynamo item to Order
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>and this is how the <code>Order.ts</code> looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {DocumentClient} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;aws-sdk/clients/dynamodb&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> Order {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">from</span>(item: <span style="color:#8be9fd">DocumentClient.AttributeMap</span>)<span style="color:#ff79c6">:</span> Order {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span>; <span style="color:#6272a4">//fake implementation
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This completes the implementation of our repository. We still have some open items. Let&rsquo;s take them one by one:</p>
<ul>
<li>Pending implementation of the <code>from()</code> method in the <code>Order</code></li>
<li>Pending implementation of the <code>orderId()</code> in the <code>OrderRequest</code></li>
<li>Pending changes relating to <code>async/await</code> in the controller, service and the handler</li>
</ul>
<h3 id="step-6-finishing-the-order-class">Step 6: Finishing the Order class</h3>
<p>The <code>order</code> class provides a static method which accepts and instance of <code>DocumentClient.AttributeMap</code> and returns an instance of <code>Order</code> consisting of orderId and amount.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {DocumentClient} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;aws-sdk/clients/dynamodb&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> Order {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">from</span>(item: <span style="color:#8be9fd">DocumentClient.AttributeMap</span>)<span style="color:#ff79c6">:</span> Order {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Order(item.orderId.S, <span style="color:#8be9fd;font-style:italic">Number</span>(item.amount.N)); <span style="color:#6272a4">//create an instance of Order from an instance of AttributeMap
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">private</span> <span style="color:#ff79c6">constructor</span>(<span style="color:#ff79c6">private</span> <span style="color:#ff79c6">readonly</span> orderId: <span style="color:#8be9fd">string</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#ff79c6">private</span> <span style="color:#ff79c6">readonly</span> amount: <span style="color:#8be9fd">number</span>) {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>AttributeMap within aws-sdk </code>is defined as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">type</span> AttributeMap <span style="color:#ff79c6">=</span> {[key: <span style="color:#8be9fd">string</span>]<span style="color:#ff79c6">:</span> AttributeValue};
</span></span></code></pre></div><p>and <code>AttributeValue</code> is an interface which is defined as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">interface</span> AttributeValue {
</span></span><span style="display:flex;"><span>    S?: <span style="color:#8be9fd">StringAttributeValue</span>;
</span></span><span style="display:flex;"><span>    N?: <span style="color:#8be9fd">NumberAttributeValue</span>;
</span></span><span style="display:flex;"><span>  .....
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Hence, <code>item.orderId</code> gives us an instance of <code>AttributeValue</code> and then we use <code>.S or .N</code> to get the corresponding value.</p>
<h3 id="step-7-finishing-the-orderrequest-class">Step 7: Finishing the OrderRequest class</h3>
<ul>
<li><code>isAGetOrder()</code> should return TRUE given a GET request beginning with <code>/orders</code> as the path part</li>
<li><code>orderId()</code> should return the value of path parameter <code>orderId</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {APIGatewayEvent} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;aws-lambda&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> OrderRequest {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">constructor</span>(<span style="color:#ff79c6">private</span> <span style="color:#ff79c6">readonly</span> event: <span style="color:#8be9fd">APIGatewayEvent</span>) {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//return true if the request is a GET request, with path starting from /orders and containing a path parameter
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    isAGetOrder()<span style="color:#ff79c6">:</span> <span style="color:#ff79c6">boolean</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.event.httpMethod <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#34;GET&#34;</span> <span style="color:#ff79c6">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#ff79c6">this</span>.event.path.startsWith(<span style="color:#f1fa8c">&#34;/orders&#34;</span>) <span style="color:#ff79c6">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#ff79c6">this</span>.event.pathParameters.orderId <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    orderId()<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.event.pathParameters.orderId; <span style="color:#6272a4">//order id is passed as path parameter
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="step-8-introducing-asyncawait-in-service-and-controller">Step 8: Introducing async/await in service and controller</h3>
<p>Let&rsquo;s introduce async and await in the handler, controller and the service.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#6272a4">//handler.ts
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">const</span> ordersHandler <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">async</span> (event: <span style="color:#8be9fd">APIGatewayEvent</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">any</span>&gt; <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">await</span> <span style="color:#ff79c6">new</span> OrderController().handle(<span style="color:#ff79c6">new</span> OrderRequest(event));
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//OrderController.ts
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">async</span> handle(orderRequest: <span style="color:#8be9fd">OrderRequest</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (orderRequest.isAGetOrder()) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">await</span> <span style="color:#ff79c6">this</span>.findAnOrderBy(orderRequest.orderId())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">private</span> <span style="color:#ff79c6">async</span> findAnOrderBy(id: <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">await</span> <span style="color:#ff79c6">this</span>.orderService.findAnOrderBy(id);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//OrderService.ts
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">async</span> findAnOrderBy(id: <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">await</span> <span style="color:#ff79c6">this</span>.repository.findAnOrderBy(id);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="step-9-lambda-response-with-api-gateway">Step 9: Lambda response with API gateway</h3>
<p>When an AWS lambda works behind an API gateway, it is expected to return a response in a specific format. This looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">&#34;statusCode&#34;</span>: Http Status Code,
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">&#34;body&#34;</span>: Response body,
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">&#34;headers&#34;</span>: Response headers
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It would be great if the controller knows the least about this structure. All it should do is return a response with an <code>Order</code> object. Let&rsquo;s create an abstraction that takes an object <code>T</code> and knows about the final HTTP response. Let&rsquo;s name this abstraction as <code>Response</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> Response&lt;<span style="color:#ff79c6">T</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">private</span> <span style="color:#ff79c6">constructor</span>(<span style="color:#ff79c6">readonly</span> status: <span style="color:#8be9fd">HttpStatus</span>, <span style="color:#ff79c6">readonly</span> body?: <span style="color:#8be9fd">T</span>) {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//signifies 200 response
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">static</span> ok&lt;<span style="color:#ff79c6">T</span>&gt;(body: <span style="color:#8be9fd">T</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Response(HttpStatus.OK, body);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//signifies 404 response
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">static</span> notFound() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Response(HttpStatus.NOT_FOUND);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> HttpStatus {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">readonly</span> OK <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;200&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">readonly</span> NOT_FOUND <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;404&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>With the introduction of the <code>Response</code> abstraction, the following will be the view of some classes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {OrderRequest} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../model/OrderRequest&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {OrderService} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../service/OrderService&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> OrderController {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">private</span> orderService: <span style="color:#8be9fd">OrderService</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">constructor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.orderService <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> OrderService();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> handle(orderRequest: <span style="color:#8be9fd">OrderRequest</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">Response</span>&lt;<span style="color:#50fa7b">Order</span> | <span style="color:#50fa7b">unknown</span>&gt;<span style="color:#ff79c6">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (orderRequest.isAGetOrder()) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">const</span> order <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> <span style="color:#ff79c6">this</span>.findAnOrderBy(orderRequest.orderId());
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4">//return an Ok response if order is found else NotFound
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">return</span> order <span style="color:#ff79c6">===</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">?</span> Response.notFound() <span style="color:#ff79c6">:</span> Response.ok&lt;<span style="color:#ff79c6">Order</span>&gt;(order);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> Response.notFound(); <span style="color:#6272a4">//return NotFound response
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">private</span> <span style="color:#ff79c6">async</span> findAnOrderBy(id: <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">await</span> <span style="color:#ff79c6">this</span>.orderService.findAnOrderBy(id);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> Response&lt;<span style="color:#ff79c6">T</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">private</span> <span style="color:#ff79c6">constructor</span>(<span style="color:#ff79c6">readonly</span> status: <span style="color:#8be9fd">HttpStatus</span>, <span style="color:#ff79c6">readonly</span> body?: <span style="color:#8be9fd">T</span>) {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">static</span> ok&lt;<span style="color:#ff79c6">T</span>&gt;(body: <span style="color:#8be9fd">T</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Response(HttpStatus.OK, body);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">static</span> notFound() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Response(HttpStatus.NOT_FOUND);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">get</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">//return a well formed JSON response
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.body <span style="color:#ff79c6">===</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">?</span> {<span style="color:#f1fa8c">&#34;statusCode&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">this</span>.status} <span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;statusCode&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">this</span>.status,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;body&#34;</span><span style="color:#ff79c6">:</span> JSON.stringify(<span style="color:#ff79c6">this</span>.body)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> HttpStatus {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">readonly</span> OK <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;200&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">readonly</span> NOT_FOUND <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;404&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If the controller returns an instance of <code>Response</code>, the handler code can be changed to invoke the <code>get()</code> on the returned instance.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {APIGatewayEvent} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;aws-lambda&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {OrderRequest}    <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;./model/OrderRequest&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {OrderController} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;./controller/OrderController&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">const</span> ordersHandler <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">async</span> (event: <span style="color:#8be9fd">APIGatewayEvent</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">any</span>&gt; <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> response <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> <span style="color:#ff79c6">new</span> OrderController().handle(<span style="color:#ff79c6">new</span> OrderRequest(event));
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> response.<span style="color:#ff79c6">get</span>(); <span style="color:#6272a4">//handler invokes get() on the response returned from controller
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>};
</span></span></code></pre></div><p>That&rsquo;s it. We have connected all the pieces, yes without any form of tests.</p>
<h3 id="step-10-adding-unit-tests">Step 10: Adding unit tests</h3>
<p>Let&rsquo;s add a couple of unit tests before we close the article. I will add all the necessary unit tests offline and commit the code. Before we can start with tests let&rsquo;s add following dependencies;</p>
<ul>
<li><code>npm install jest --save-dev</code></li>
<li><code>npm install @types/jest --save-dev</code></li>
<li><code>npm install ts-jest --save-dev</code></li>
<li><code>npm install sinon --save-dev</code></li>
</ul>
<p>jest configuration in <code>jest.config.js</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span>module.exports <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;testMatch&#34;</span><span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;**/__tests__/**/*.+(ts|tsx|js)&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;**/?(*.)+(spec|test).+(ts|tsx|js)&#34;</span>
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;transform&#34;</span><span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;^.+\\.(ts|tsx)$&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;ts-jest&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>test script in <code>package.json</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#f1fa8c">&#34;scripts&#34;</span><span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;test&#34;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;jest test/**&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="controller-unit-tests">Controller unit tests</h3>
<p>Let&rsquo;s add our first test that attempts to validate the status for finding an order by its id.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {OrderController} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../../src/controller/OrderController&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {OrderRequest} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../../src/model/OrderRequest&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {APIGatewayEvent} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;aws-lambda&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {HttpStatus} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../../src/model/ModelAndResponseStatus&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {OrderService} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../../src/service/OrderService&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> {Order} <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;../../src/model/Order&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">as</span> sinon <span style="color:#ff79c6">from</span> <span style="color:#f1fa8c">&#34;sinon&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>test(<span style="color:#f1fa8c">&#34;should return Ok as the response status given a request to find an order by id&#34;</span>, <span style="color:#ff79c6">async</span> () <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    sinon.stub(OrderService.prototype, <span style="color:#f1fa8c">&#34;findAnOrderBy&#34;</span>)
</span></span><span style="display:flex;"><span>        .callsFake(() <span style="color:#ff79c6">=&gt;</span> sinon.mock(Order));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> response <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> <span style="color:#ff79c6">new</span> OrderController().handle(orderRequest(<span style="color:#f1fa8c">&#34;id-100&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    expect(response.status).toEqual(HttpStatus.OK);
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>afterEach(() <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    sinon.restore();
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> orderRequest <span style="color:#ff79c6">=</span> (id: <span style="color:#8be9fd">string</span>) <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> apiGatewayEvent: <span style="color:#8be9fd">APIGatewayEvent</span> <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>        httpMethod<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;GET&#34;</span>,
</span></span><span style="display:flex;"><span>        path<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">`/orders/</span><span style="color:#f1fa8c">${</span>id<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>,
</span></span><span style="display:flex;"><span>        pathParameters<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;orderId&#34;</span><span style="color:#ff79c6">:</span> id
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        body: <span style="color:#8be9fd">null</span>,
</span></span><span style="display:flex;"><span>        isBase64Encoded: <span style="color:#8be9fd">false</span>,
</span></span><span style="display:flex;"><span>        headers<span style="color:#ff79c6">:</span> {},
</span></span><span style="display:flex;"><span>        multiValueHeaders<span style="color:#ff79c6">:</span> {},
</span></span><span style="display:flex;"><span>        queryStringParameters<span style="color:#ff79c6">:</span> {},
</span></span><span style="display:flex;"><span>        multiValueQueryStringParameters<span style="color:#ff79c6">:</span> {},
</span></span><span style="display:flex;"><span>        stageVariables<span style="color:#ff79c6">:</span> {},
</span></span><span style="display:flex;"><span>        requestContext: <span style="color:#8be9fd">null</span>,
</span></span><span style="display:flex;"><span>        resource<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> OrderRequest(apiGatewayEvent);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>One quick observation:</p>
<ul>
<li><code>apiGatewayEvent</code> had to be constructed with all the attributes even though we needed only pathParameters because <code>APIGatewayEvent</code> type mandates all the attributes</li>
<li>visibility of status and model (in the next test) had to be changed from private to public, to assert on these fields</li>
</ul>
<p>Another test could be to check the order returned from controller given an id.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span>test(<span style="color:#f1fa8c">&#34;should return an order given a request to find an order by id&#34;</span>, <span style="color:#ff79c6">async</span> () <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    sinon.stub(OrderService.prototype, <span style="color:#f1fa8c">&#34;findAnOrderBy&#34;</span>)
</span></span><span style="display:flex;"><span>         .callsFake(() <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">new</span> Order(<span style="color:#f1fa8c">&#34;id-100&#34;</span>, <span style="color:#bd93f9">1445</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> response <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> <span style="color:#ff79c6">new</span> OrderController().handle(orderRequest(<span style="color:#f1fa8c">&#34;id-100&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    expect(response.body<span style="color:#ff79c6">!!</span>).toEqual(<span style="color:#ff79c6">new</span> Order(<span style="color:#f1fa8c">&#34;id-100&#34;</span>, <span style="color:#bd93f9">1445</span>));
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>I guess we are ready to do TDD as well for Serverless.</p>
<h3 id="summary">Summary</h3>
<p>Finally, we have come to an end of our first article where we made an attempt to design a small part of a serverless application that uses AWS Lambda, API Gateway and DynamoDB.</p>
<p>As a part of this application we have tried to draw some parallels with the MVC design pattern and bring the same to the serverless world.</p>
<p><strong>Items that we have left:</strong></p>
<ul>
<li>Exception handling is missing</li>
<li>Controller checks if the request is for getting an order. This if/else ladder will grow given the same lambda handles creation and deletion of orders.</li>
<li>Every component is unit testable in itself, except the repository layer that needs DynamoDB.</li>
</ul>
<p>I am sure you will be able to fill these gaps and at this stage, I will move forward.</p>
<p><strong>There is a lot of work still left before we can deploy the code:</strong></p>
<ul>
<li>We need to have integration test(s) which can give us confidence if this entire application is actually working or not</li>
<li>We need to integrate CDK (Cloud Development Kit) for deploying our infrastructure</li>
<li>We need to have unit tests and snapshot tests for our CDK based infra code</li>
</ul>
<p>Code is available <a href="https://github.com/aws-articles/serverless-order-service" target="_blank" rel="noopener">here</a>
.</p>
<p>Let&rsquo;s move on to our <a href="/en/blog/testing_serverless_journey">next</a>
 article that explores integration testing using Localstack for our serverless application.</p>

  </article>
<div class="tag-list-container">
    <div class="tag-list">
        
        <a class="button" href="">
            <p class="tag"><i class="fa fa-fw fa-tag"></i>AWS Lambda</p>
        </a>
        
        <a class="button" href="">
            <p class="tag"><i class="fa fa-fw fa-tag"></i>Serverless</p>
        </a>
        
    </div>
</div>



<div class="px-2 mb-2">
  
  <script src="https://giscus.app/client.js"
    data-repo="SarthakMakhija/tech-lessons-comments"
    data-repo-id="R_kgDOJHu3mA"
    data-category="Announcements"
    data-category-id="DIC_kwDOJHu3mM4CUxhS"
    data-mapping="og:title"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="light"
    data-lang="en"
    crossorigin="anonymous"
    async>
  </script>
  
</div>



    </main><footer class="container p-6 mx-auto flex justify-between items-center">
  <span></span>

  <span class="text-base font-thin">
    
    tech-lessons.in  2020 / Powered by  <a class="font-bold" target="_blank" href="https://gohugo.io/">Hugo</a>
    
  </span>

  <span onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="p-1 cursor-pointer">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" stroke-width="1.5"
      stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M18 15l-6 -6l-6 6h12" />
    </svg>
  </span>
</footer>

<div class="search-ui absolute top-0 left-0 w-full h-full bg-white dark:bg-gray-800 hidden">
  <div class="container max-w-3xl mx-auto p-12">
    <div class="relative">
      <div class="my-4 text-center text-2xl font-bold">Search</div>

      <span class="p-2 absolute right-0 top-0 cursor-pointer close-search">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </span>
    </div>

    <input type="search" class="py-2 px-3 w-full dark:text-black border dark:border-transparent"
      placeholder="Enter search query" />

    <div class="search-results text-lg font-medium my-4 hidden">Results</div>
    <ul class="search-list my-2">

    </ul>

    <div class="no-results text-center my-8 hidden">
      <div class="text-xl font-semibold mb-2">No results found</div>
      <p class="font-light text-sm">Try adjusting your search query</p>
    </div>
  </div>
</div>





<script src="//localhost:1313/js/scripts.min.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-9KKTKFQ2CM"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-9KKTKFQ2CM');
        }
      </script>





<script>
  const mobileMenuButton = document.querySelector('.mobile-menu-button')
  const mobileMenu = document.querySelector('.mobile-menu')
  function toggleMenu() {
    mobileMenu.classList.toggle('hidden');
    mobileMenu.classList.toggle('flex');
  }
  if(mobileMenu && mobileMenuButton){
    mobileMenuButton.addEventListener('click', toggleMenu)
  }
</script>
</body>
</html>
